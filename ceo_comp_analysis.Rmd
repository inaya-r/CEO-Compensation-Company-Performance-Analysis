---
title: "Analyzing CEO Compensation: Correlations & Predictive Modeling"
author: "Anushna Gunda, Inaya Rizvi, Harsh Malik, Sai Bathina"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: yes
    toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: '3'
    df_print: paged
    number_sections: yes
    theme: united
    code_folding: none
---


Below I have created first-level headings for the project. You can add your own second-level (or third-level) headings by adding ## or ### before the sub-heading. I also added a code chunk under the #Results section just to show you how to get started. Once you are ready to knit your markdown file into a Word doc, delete this paragraph. kl

# Introduction
CEO compensation is a key metric in corporate governance and financial analysis. Our goal is to analyze what factors are most correlated with CEO pay and whether we can predict CEO compensation based on financial and market indicators.

# Research Questions
- What company financial and market factors influence CEO compensation?
- Can we create a regression model to predict CEO total compensation?

# Data and Methods

**Source:** Pitchbook 

## Overview of Dataset
Using pitchbook, we custom-formatted a dataset that includes **CEO total compensation** as the dependent variable and the following independent variables:

- **Company Financials:** Total Revenue, Revenue per Employee, EBITDA Margin, etc.

- **Profitability Metrics:** ROIC, Net Profit Margin, Revenue Growth.

- **Debt & Leverage:** Net Debt, Debt to Capital, Total Assets.

- **Market Indicators:** Price % Change YTD, Beta (5-year), EV, EV/EBITDA.

- **Categorical Factors:** HQ State/Province, Primary Industry Group (for identification and clustering)

## Data Import & Preprocessing
Includes formatting column names and negative values (ceo_data), and handling null values by replacing null with medians (quantitative) or mode (qualitative) (imputed_data)

AFTER RUNNING THIS CODE CHUNK:
there are 2 datasets you can use:

ceo_data = clean but with NA values for missing data
imputed_data = clean with NA values replaced with median or mode (depending on data type) 

```{r, message=FALSE, warning=FALSE}

# Loading Required Libraries
library(tidyverse)   # Data manipulation
library(mice)        # Missing data imputation
library(dplyr)

# Loading the Dataset
raw_data <- read.csv("ceo_comp_data.csv", na.strings = c("", "NA"))


# Fixing Column Names
ceo_data <- raw_data %>%
  rename(
    total_revenue = "Total.Revenue..FY.",
    revenue_per_employee= "Revenue.per.Employee..FY.", 
    roic = "ROIC..Return.on.Invested.Capital...FY.",
    net_profit_margin = "Net.Profit.Margin..FY.",
    ebitda_margin = "EBITDA.Margin..FY.",
    revenue_growth = "Revenue...Growth..FY.",
    net_debt = "Net.Debt..FY.",
    debt_to_capital = "Debt.to.Capital..FY.",
    total_assets = "Total.Assets..FY.",
    price_change_ytd = "Price...Change.YTD",
    ev = "EV..FY.",
    hq = "HQ.State.Province",
    primary_industry_group = "Primary.Industry.Group",
    ceo = "CEO",
    ceo_total_comp_mils = "CEO.Total.Compensation..in.millions."
  )

# Viewing the new column names
colnames(ceo_data)

# Viewing Basic Info
str(ceo_data)   # Check structure
summary(ceo_data)  # Summary statistics
print(ceo_data)  # Quick data preview

numeric_cols <- c("roic", "net_profit_margin", "ebitda_margin", "revenue_growth", 
                   "net_debt", "price_change_ytd", "ev", "revenue_per_employee",
                  "debt_to_capital")

# Converting Character Columns to Numeric (Fix Negative Parentheses Format)
convert_negatives_column <- function(column) {
  column <- as.character(column)  # Convert to character
  
  for (i in seq_along(column)) {  
    if (!is.na(column[i]) && column[i] != "") {  # Skip NA or empty values
      column[i] <- trimws(column[i])  # Remove any leading/trailing spaces
      
      if (grepl("^\\(.*\\)$", column[i])) {  # Check if value has parentheses
        column[i] <- gsub("[(),]", "", column[i])  # Remove parentheses & commas
        column[i] <- as.numeric(column[i]) * -1  # Convert to negative
      } else {
        column[i] <- gsub(",", "", column[i])  # Remove commas from numbers
        column[i] <- as.numeric(column[i])  # Convert normally
      }
      
      # If conversion fails, set it to NA explicitly (to catch errors)
      if (is.na(column[i])) {
        column[i] <- NA
      }
    }
  }
  
  return(as.numeric(column))  # Ensure the final output is numeric
}


# Apply fix to all numeric columns
for (col in numeric_cols) {
  ceo_data[[col]] <- convert_negatives_column(ceo_data[[col]])
}

#  Check the Final Cleaned Data
summary(ceo_data)
str(ceo_data)

#  Create a Copy for Imputation
imputed_data <- ceo_data

#  Impute Missing Values (Numeric: Median Imputation)
impute_median <- function(column) {
  column[is.na(column)] <- median(column, na.rm = TRUE)
  return(column)
}

imputed_data[numeric_cols] <- lapply(imputed_data[numeric_cols], impute_median)

# Impute Categorical Variables (Mode Imputation)
mode_impute <- function(column) {
  column[is.na(column)] <- names(sort(table(column), decreasing = TRUE))[1]
  return(column)
}

categorical_cols <- c("primary_industry_group", "hq")  
imputed_data[categorical_cols] <- lapply(imputed_data[categorical_cols], mode_impute)

# Check the Imputed Dataset
summary(imputed_data)
glimpse(imputed_data)

#  Optional - Save Cleaned Datasets
# write.csv(ceo_data, "ceo_comp_data_raw.csv", row.names = FALSE)
# write.csv(imputed_data, "ceo_comp_data_imputed.csv", row.names = FALSE)

```

## Exploratory Analysis

### Summary Statistics
```{r}

```

### Distributions of key variables 
-- maybe histogram of CEO compensation distribution
```{r}

```

### Correlation matrix to check relationships between dependent variables
```{r}

```
-- interpret correlations, are higher revenues associated with higher CEO pay? or debt levels, etc. 

### Visualizations 
some ideas maybe:
-- box plots of CEO comp by industry (also maybe run ANOVA test in conjunction to see if CEO comp differs significantly between industries)
-- scatter plots of CEO comp vs. total rev, ROIC, net income growth
-- test CEO compensation differences based on debt-levels 
      -- split companies into high and low debt using median as             divider
      -- use a t-test (if normal dist.), Wilcoxon test (if skewed)             (look at overall histogram of CEO comp for this)

## Regression Analysis

### Multiple Linear Regression: CEO Compensation ~ Financial Metrics

-- which variables are statistically significant?
-- are there unexpected relationships?
-- check for multicollinearity
-- use R-squared and residual plots to assess model performance



-- consider running a Shapiro-Wilk and Breusch-Pagan Test to check assumptions in model (ask inaya or chatGPT if you have questions)


### Network Analysis - Clustering

-- Are there industry-based clusters where CEO pay is higher?

```{r, warning=FALSE, message=FALSE}
# Load necessary libraries
library(igraph)    # For network analysis
library(ggraph)    # For network visualization
library(tidyverse) # For data manipulation
library(scales)    # For rescaling values
library(viridis)   # For better color gradients

# First prepare the clustering data from ceo_data
clustering_data <- ceo_data %>%
  # Replace NA in HQ.State.Province with "Outside US"
  mutate(HQ.State.Province = ifelse(is.na(HQ.State.Province) | HQ.State.Province == "", 
                                   "Outside US", HQ.State.Province),
         # Convert Ireland and Netherlands to the combined category
         HQ.State.Province = ifelse(HQ.State.Province %in% c("Ireland", "Netherlands"), 
                                   "Ireland/Netherlands", HQ.State.Province))

# Check for duplicates in company_id
duplicates <- clustering_data %>% 
  count(company_id) %>% 
  filter(n > 1)

# Handle duplicates if they exist
if(nrow(duplicates) > 0) {
  clustering_data <- clustering_data %>%
    group_by(company_id) %>%
    mutate(id_suffix = if(n() > 1) paste0("_", row_number()) else "") %>%
    ungroup() %>%
    mutate(company_id = paste0(company_id, id_suffix)) %>%
    select(-id_suffix)
}

# Create the vertex data frame with compensation data
vertex_data <- clustering_data %>%
  select(company_id, hq = HQ.State.Province, compensation = CEO.Total.Compensation..in.millions.) %>%
  mutate(compensation = as.numeric(as.character(compensation))) %>% # Convert to numeric
  filter(!is.na(compensation))  # Remove records with missing compensation

# Create edge list based on HQ location
edge_list <- vertex_data %>%
  select(company_id, hq) %>%
  group_by(hq) %>%
  filter(n() > 1) %>%  # Only connect companies in same location 
  group_map(~{
    ids <- .x$company_id
    if(length(ids) >= 2) {
      edges <- t(combn(ids, 2))
      data.frame(from = edges[,1], to = edges[,2])
    }
  }) %>%
  bind_rows()

# Verify that all edge vertices exist in the vertex data
edge_vertices <- unique(c(edge_list$from, edge_list$to))
missing_vertices <- edge_vertices[!edge_vertices %in% vertex_data$company_id]

if(length(missing_vertices) > 0) {
  print(paste("Missing vertices:", paste(missing_vertices, collapse=", ")))
  # Remove problem edges
  edge_list <- edge_list %>%
    filter(!(from %in% missing_vertices | to %in% missing_vertices))
}

# Create the igraph object
g <- graph_from_data_frame(edge_list, directed = FALSE, vertices = vertex_data)

# Calculate node size based on CEO compensation (normalized for better visualization)
compensation_numeric <- as.numeric(V(g)$compensation)
V(g)$node_size <- scales::rescale(compensation_numeric, to = c(3, 15))

# Calculate compensation categories for coloring
compensation_breaks <- c(0, 5, 10, 20, 50, 100, max(compensation_numeric, na.rm = TRUE))
V(g)$comp_category <- cut(compensation_numeric, 
                         breaks = compensation_breaks,
                         labels = c("<$5M", "$5-10M", "$10-20M", "$20-50M", "$50-100M", ">$100M"),
                         include.lowest = TRUE)

# Plot the network graph showing CEO compensation clustering by HQ location
ggraph(g, layout = 'fr') +
  geom_edge_link(alpha = 0.3, width = 0.5) +
  geom_node_point(aes(size = node_size, color = comp_category)) +
  geom_node_text(aes(label = hq), repel = TRUE, size = 3, alpha = 0.8) +
  scale_color_viridis_d(option = "plasma", end = 0.9) +
  scale_size_identity() +
  theme_void() +
  labs(title = "CEO Compensation Clustering by Headquarters Location",
       subtitle = "Node size represents compensation amount, color represents compensation range",
       caption = "Companies connected by same HQ location",
       color = "CEO Compensation") +
  guides(size = "none") +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 12),
    legend.position = "right"
  )
```

# Results
Describe results in this section

You can add text above and below code chunks

# Discussion


